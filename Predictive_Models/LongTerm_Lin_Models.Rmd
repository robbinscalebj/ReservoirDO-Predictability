---
title: "LongTerm_Lin_Models"
output: html_document
date: "2022-09-15"
---

## Overall goals:
The goal of this markdown is building and testing predictive linear models (and extensions) trained on long-term data from Richland-Chambers reservoir.

Model types: 
- Linear regression
- Regularized regression
- Generalized additive models

Response variable
- Dissolved oxygen (mg/L)

Predictors (any lagged combinations of these)
- Wind (N and W components) 
- Air temperature
- Dewpoint
- Air pressure
- Cloud Cover
- Depth

Generally, we can use the tidymodels approach to work with our data. The exception is that I've already split data into trained/validation sets in another R script (Collate_LongTerm_Data.R) and written those data to separate .csv files.


```{r setup}
library(tidymodels)
library(tidyverse)
```


```{r load data}
#Data were created in Collate_LongTerm_Data.R - read XXX.csv
RC <- read_csv("RC_pred_longterm_training_fullmeteo.csv")
```


# Data preprocessing - "feature engineering"

Data pre-processing is done in the tidymodels framework with 'recipes', which take the data and tidily changes variables (e.g., log transformations, creating dummy variables) as we need to in preparation for putting the data into specific models. 

What we really want is for linear regression to have separate models using different lags. For now, we'll just test a full model. 

For the first of these recipes, we'll tell the recipe our model formula is all variables, remove two of the variables we don't want to use as predictors, and create lags on our predictor variables because we assume that lagged versions of our predictors could be important.


```{r }


#rc_lm_forms <- leave_var_out_formulas(DO_mg.L ~ .,data = RC) #could use use on each juiced recipe, I suppose

rec_base = recipe(DO_mg.L ~ ., data = RC)|>
  step_rm("Datetime","WaterTemp_C")

rec_lag0 <- rec_base|>
  step_filter(!is.na(DO_mg.L))

rec_lag1 <- rec_base|>
  step_lag(-doy, -time_of_day, -Depth_m, -DO_mg.L, lag = 1)|>
  step_select(doy, time_of_day, Depth_m, DO_mg.L, contains("lag"))|>
  step_filter(!is.na(DO_mg.L))

rec_lag6 <- rec_base|>
  step_lag(-doy, -time_of_day, -Depth_m, -DO_mg.L, lag = 6)|>
  step_select(doy, time_of_day, Depth_m, DO_mg.L, contains("lag"))|>
  step_filter(!is.na(DO_mg.L))

rec_lag12 <- rec_base|>
  step_lag(-doy, -time_of_day, -Depth_m, -DO_mg.L, lag = 12)|>
  step_select(doy, time_of_day, Depth_m, DO_mg.L, contains("lag"))|>
  step_filter(!is.na(DO_mg.L))

rec_lag24 <- rec_base|>
  step_lag(-doy, -time_of_day, -Depth_m, -DO_mg.L, lag = 24)|>
  step_select(doy, time_of_day, Depth_m, DO_mg.L, contains("lag"))|>
  step_filter(!is.na(DO_mg.L))

rec_lag36 <- rec_base|>
  step_lag(-doy, -time_of_day, -Depth_m, -DO_mg.L, lag = 36)|>
  step_select(doy, time_of_day, Depth_m, DO_mg.L, contains("lag"))|>
  step_filter(!is.na(DO_mg.L))

rec_lag48 <- rec_base|>
  step_lag(-doy, -time_of_day, -Depth_m, -DO_mg.L, lag = 48)|>
  step_select(doy, time_of_day, Depth_m, DO_mg.L, contains("lag"))|>
  step_filter(!is.na(DO_mg.L))

rec_lag72 <- rec_base|>
  step_lag(-doy, -time_of_day, -Depth_m, -DO_mg.L, lag = 72)|>
  step_select(doy, time_of_day, Depth_m, DO_mg.L, contains("lag"))|>
  step_filter(!is.na(DO_mg.L))

rec_lag144 <- rec_base|>
  step_lag(-doy, -time_of_day, -Depth_m, -DO_mg.L, lag = 144)|>
  step_select(doy, time_of_day, Depth_m, DO_mg.L, contains("lag"))|>
  step_filter(!is.na(DO_mg.L))


rc_lm_df <- prep(rec_lag144)|>juice() #check that these dataframes are coming out right

```

#define models
```{r}
#set engine - very easy in this case
lm_spec <- linear_reg() |> 
  set_engine("glm")

lm_workflow <- workflow_set(
  preproc = list(rec_lag0,rec_lag1,rec_lag6,rec_lag12,rec_lag24,rec_lag36,rec_lag48,rec_lag72,rec_lag144),
  models = list(lm_spec)
)|>
   mutate(fit = map(info, ~ fit(.x$workflow[[1]], RC)))

lm_fits <- fit(lm_workflow, data = RC)

#folds <- vfold_cv(RC, v = 5)

#lm_fit <-fit_resamples(
  object = lm_spec,
      preprocessor = rc_lm_rec, 
      resamples = folds)

#lm_fit

mc_cv(juice(rc_lm_rec))
```